# WIMSE アーキテクチャ図

## デプロイメントアーキテクチャと通信フロー

以下のmermaid図は、WIMSEのデプロイメントアーキテクチャと通信フローを示しています。

```mermaid
graph TD
    A[ワークロードA]
    B[ワークロードB]
    PEP[PEP]
    PDP["PDP<br>: オプション"]
    IS["アイデンティティ<br>サーバー"]

    subgraph "ワークロード通信"
        B --|1. トランスポート接続の確立|--> A
        A --|3. HTTP呼び出し|--> B
        B --|5. レスポンス|--> A
    end
    
    subgraph "認証と認可"
        B --> PEP
        PEP --|4. 認可決定|--> PDP
    end
    
    subgraph "アイデンティティ管理"
        IS --|2a. 認証情報の提供|--> A
        IS --|2b. 認証情報の提供|--> B
    end
    
    classDef workload fill:#a8d1ff,stroke:#0066cc,stroke-width:2px;
    classDef security fill:#ffcccc,stroke:#cc0000,stroke-width:2px;
    classDef identity fill:#d1e7dd,stroke:#198754,stroke-width:2px;
    
    class A,B workload;
    class PEP,PDP security;
    class IS identity;
```

## 通信フローの説明

1. **トランスポート接続の確立**:
   - 相互TLSの場合: この段階で両方のワークロードが互いに認証されます
   - アプリケーションレベルのセキュリティの場合: TLS接続は通常一方向の認証で、ワークロードレベルの認証はまだ行われません

2. **認証情報の取得**:
   - ワークロードA（およびワークロードB）はアイデンティティサーバーから認証情報を取得します
   - これは定期的に行われます（例：24時間ごと）

3. **HTTP呼び出し**:
   - ワークロードAはワークロードBにHTTP呼び出しを行います
   - これは通常のHTTPリクエストに、追加の保護メカニズムを加えたものです

4. **認証と認可**:
   - アプリケーションレベルのセキュリティの場合: ワークロードBはワークロードAを認証します（相互TLSの場合、これはステップ1で行われています）
   - いずれの場合も、ワークロードBは呼び出しを許可するかどうかを決定します
   - 特定のアーキテクチャでは、ワークロードBはこの決定を行う際に外部サーバー（PDP）に相談する必要がある場合があります

5. **レスポンスの返却**:
   - ワークロードBはワークロードAにレスポンスを返します
   - これはエラーレスポンスまたは通常のレスポンスのいずれかです
