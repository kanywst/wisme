# WIMSE アーキテクチャと通信フロー

## デプロイメントアーキテクチャ

WIMSEでは、ワークロード間の通信に関わらず、以下の論理アーキテクチャを想定しています：

```
+------------+               +------------+
|            |      (1)      |            |
|            |<=============>|            |
|            |               |            |
| ワークロードA |      (3)      | ワークロードB |
|            |==============>|            |
|            |               |            |
|            |      (5)      |   +--------+
|            |<==============|   |  PEP   |
+------------+               +---+--------+
      ^                        ^     ^
      |            (2)         |     |
  (2) | +----------------------+     | (4)
      | |                            |
      v v                            v
+------------+               +------------+
|            |               |            |
| アイデンティティ |               |    PDP     |
|   サーバー   |               | (オプション) |
|            |               |            |
+------------+               +------------+
```

### 主要コンポーネント

- **ワークロードA、B**: 相互に通信する必要があるアプリケーションやサービス
- **アイデンティティサーバー**: ワークロードに認証情報を提供するサーバー
- **PEP (Policy Enforcement Point)**: 通信を許可または拒否するコンポーネント
- **PDP (Policy Decision Point)**: ポリシー管理が中央集権化されているアーキテクチャで使用される、オプションのコンポーネント

## 通信フロー

1. **トランスポート接続の確立**:
   - 相互TLSの場合: この段階で両方のワークロードが互いに認証されます
   - アプリケーションレベルのセキュリティの場合: TLS接続は通常一方向の認証で、ワークロードレベルの認証はまだ行われません

2. **認証情報の取得**:
   - ワークロードA（およびワークロードB）はアイデンティティサーバーから認証情報を取得します
   - これは定期的に行われます（例：24時間ごと）

3. **HTTP呼び出し**:
   - ワークロードAはワークロードBにHTTP呼び出しを行います
   - これは通常のHTTPリクエストに、以下で定義される追加の保護メカニズムを加えたものです

4. **認証と認可**:
   - アプリケーションレベルのセキュリティの場合: ワークロードBはワークロードAを認証します（相互TLSの場合、これはステップ1で行われています）
   - いずれの場合も、ワークロードBは呼び出しを許可するかどうかを決定します
   - 特定のアーキテクチャでは、ワークロードBはこの決定を行う際に外部サーバーに相談する必要がある場合があります

5. **レスポンスの返却**:
   - ワークロードBはワークロードAにレスポンスを返します
   - これはエラーレスポンスまたは通常のレスポンスのいずれかです

## 認証プロトコルの選択

WIMSEでは、デプロイメントスタイルに応じて2つの認証プロトコルを提供しています：

1. **アプリケーションレベルの認証**:
   - ワークロード間にミドルボックスが挿入されるデプロイメントに適しています
   - エンドツーエンドの暗号化されたトランスポート層がない場合に使用します
   - HTTPメッセージをアプリケーションレベルで保護します

2. **相互TLS（mTLS）を使用した認証**:
   - ワークロードのペア間に相互TLS接続がある場合に適しています
   - よりシンプルなソリューションを提供します

これらのプロトコルは互換性があり、マルチチェーン呼び出しの中で両方のアーキテクチャを含めることができます。例えば、ワークロードAは相互TLS保護を使用してワークロードBを呼び出し、次のワークロードCへの呼び出しはアプリケーションレベルで保護することができます。
