# WIMSE 相互TLS（mTLS）を使用したワークロード間認証

## 概要

多くのデプロイメントでは、アプリケーショントラフィックをトランスポートレベルでTLSを使用して保護することが理想的です。このソリューションでは、WIMSE ワークロードアイデンティティをX.509証明書内に格納します。

## WIMSE証明書の要件

WIMSE ワークロードアイデンティティは、URI型のSubjectAltName拡張にエンコードする必要があります。WIMSE証明書には、URI型のSubjectAltName拡張が1つだけ含まれている必要があります。

WIMSE証明書を理解しないクライアントのTLSサーバーとしてワークロードが機能する場合、WIMSE証明書にはサーバーの適切なDNS名を持つDNSName型のSubjectAltNameを含めることが推奨されます。証明書には他のタイプのSubjectAltName拡張が含まれていてもかまいません。

## 証明書の使用

WIMSE証明書は、接続のサーバー側とクライアント側の両方を認証するために使用できます。WIMSE証明書を検証する際、依存するパーティはWIMSEアイデンティティの信頼ドメインに対して構成された信頼アンカーを使用して、ピアの証明書を検証する必要があります。他のPKIX（RFC5280）パス検証ルールも適用されます。WIMSEクライアントとサーバーは、WIMSE証明書の信頼ドメイン部分が接続の反対側に対して期待される信頼ドメインと一致することを検証する必要があります。

クライアント認証にWIMSE証明書を使用したいサーバーは、TLSハンドシェイクでクライアント証明書認証を要求する必要があります。ハンドシェイク後の他の認証方法はこのドキュメントでは指定されていません。

WIMSE サーバー証明書には、id-kp-serverAuth拡張キー使用フィールドを設定し、WIMSEクライアント証明書にはid-kp-clientAuth拡張キー使用フィールドを設定することが推奨されます。クライアントとサーバーの両方の接続に使用される証明書には、両方のフィールドが設定されている場合があります。

## サーバー名の検証

WIMSEクライアントがホスト名を使用してサーバーに接続し、サーバー証明書にDNS SANが含まれている場合、クライアントはピアのWIMSEアイデンティティを検証するために必要な情報で構成されていない限り、標準のホスト名検証（RFC9525のセクション6.3）を実行する必要があります。

クライアントが標準のホスト名検証を実行しなかった場合、WIMSEクライアントはさらにWIMSEワークロード識別子を使用してサーバーを検証する必要があります。WIMSEワークロード識別子のホスト部分は、RFC9525のセクション6.4で指定されているようなホスト名としては扱われず、信頼ドメインとして扱われます。サーバーアイデンティティは、デプロイメント固有の方法でWIMSEワークロード識別子のパス部分にエンコードされます。

WIMSEワークロードアイデンティティの検証は、信頼ドメインとパス部分の単純な一致であるか、識別子の構築方法の特定の詳細に基づく検証である可能性があります。WIMSEアイデンティティのパス部分は常に信頼ドメインの範囲内で考慮する必要があります。

## WIMSEアイデンティティを使用したクライアント認可

サーバーアプリケーションは、TLS層から取得したクライアント証明書のsubjectAltNameからWIMSEワークロード識別子を取得します。この識別子は、認可、アカウンティング、および監査に使用されます。

例えば、完全なWIMSEワークロード識別子をACLと照合して、ピアによって要求されたアクションを認可したり、識別子を監査目的でクライアントワークロードにアクションを関連付けるためにログメッセージに含めたりすることができます。デプロイメントは、WIMSEアイデンティティの構築方法の特定の詳細に基づいて、他の認可ポリシーを指定する場合があります。WIMSEアイデンティティのパス部分は常に信頼ドメインの範囲内で考慮する必要があります。

## mTLSとアプリケーションレベル認証の比較

### mTLSの利点

- **シンプルさ**: トランスポートレベルでの認証は、アプリケーションレベルの認証よりもシンプルです
- **既存のインフラストラクチャ**: 多くの組織では、すでにTLS証明書の管理インフラストラクチャが整っています
- **広範なサポート**: TLSはほとんどのプログラミング言語とフレームワークで広くサポートされています
- **パフォーマンス**: アプリケーションレベルの認証と比較して、追加のHTTPヘッダーや署名検証のオーバーヘッドがありません

### mTLSの制限

- **ミドルボックスとの互換性**: 一部のデプロイメント環境では、ミドルボックス（プロキシ、ロードバランサーなど）がエンドツーエンドのmTLSを妨げる場合があります
- **証明書管理**: X.509証明書の管理は、特に大規模な環境では複雑になる可能性があります
- **更新の複雑さ**: 証明書の更新プロセスは、特に多数のワークロードがある場合、調整が必要です

## 実装上の考慮事項

mTLSを使用してWIMSEワークロード間認証を実装する際は、以下の点を考慮することが重要です：

1. **証明書ライフサイクル管理**: 証明書の発行、更新、失効のプロセスを確立します
2. **信頼アンカーの管理**: 各信頼ドメインの信頼アンカーを安全に配布および更新するメカニズムを確保します
3. **クライアント認証の強制**: サーバーがTLSハンドシェイク中にクライアント証明書を要求するように構成されていることを確認します
4. **適切な検証**: ワークロード識別子と信頼ドメインの両方に対して適切な検証を実装します
5. **証明書失効チェック**: 必要に応じて、証明書失効リスト（CRL）やOCSP（Online Certificate Status Protocol）などのメカニズムを使用して、失効した証明書をチェックします

## アプリケーションレベル認証とmTLSの併用

WIMSEアーキテクチャの重要な特徴の1つは、単一の呼び出しチェーン内でアプリケーションレベルの認証とmTLS認証の両方を使用できることです。これにより、異なるセキュリティ要件や制約を持つ様々な環境にまたがるワークロード間の通信が可能になります。

例えば、ワークロードAはmTLS認証を使用してワークロードBを呼び出し、次にワークロードBからワークロードCへの呼び出しはアプリケーションレベルで認証することができます。この柔軟性により、組織は各接続に最も適した認証メカニズムを選択できます。
